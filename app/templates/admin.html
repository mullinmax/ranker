{% extends "base.html" %}
{% block title %}Admin{% endblock %}
{% block content %}
<h2>Users</h2>
<table class="stats-table">
  <tr><th>User</th><th>Rankings</th><th>Actions</th></tr>
  {% for user in users %}
  <tr>
    <td>{{ user }}</td>
    <td>{{ rating_counts.get(user, 0) }}</td>
    <td>
      <form method="post" action="/admin/delete_user" onsubmit="return confirm('Delete user and all data?');">
        <input type="hidden" name="target_user" value="{{ user }}" />
        <button type="submit">Delete</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>
<h2>Change User Password</h2>
<form method="post" action="/admin/change_password">
  <select name="target_user">
    {% for user in users %}
    <option value="{{ user }}">{{ user }}</option>
    {% endfor %}
  </select>
  <input type="password" name="new_password" placeholder="New password" required />
  <input type="submit" value="Change Password" />
</form>
<h2>Upload Media</h2>
<form id="upload-form" method="post" action="/admin/upload_media" enctype="multipart/form-data">
  <input type="file" name="media_files" multiple required />
  <input type="submit" value="Upload" />
</form>
<h2>Remove Duplicate Images</h2>
<form method="post" action="/admin/remove_duplicates" onsubmit="return confirm('Remove duplicate images?');">
  <button type="submit">Remove Duplicates</button>
</form>
<h2>Ollama Settings</h2>
<form method="post" action="/admin/set_ollama">
  <input type="text" name="url" placeholder="URL" value="{{ ollama_url }}" required />
  <input type="text" name="api_key" placeholder="API Key" value="{{ ollama_api_key }}" />
  <input type="text" name="model" placeholder="Model" value="{{ ollama_model }}" required />
  <button type="submit">Save</button>
</form>
<h2>Generate Embeddings</h2>
<form method="post" action="/admin/generate_embeddings" onsubmit="return confirm('Generate embeddings?');">
  <button type="submit">Generate Embeddings</button>
</form>
<script>
const form = document.getElementById('upload-form');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const input = form.querySelector('input[type="file"]');
  const files = Array.from(input.files);
  const batchSize = 10;
  for (let i = 0; i < files.length; i += batchSize) {
    const chunk = files.slice(i, i + batchSize);
    const fd = new FormData();
    chunk.forEach(f => fd.append('media_files', f));
    await fetch(form.action, {method: 'POST', body: fd});
  }
  window.location.reload();
});
</script>
<p class="build-info">Build {{ build_number }}</p>
<h2>Media Summary</h2>
<p>Total files: {{ media_total }}</p>
<ul>
  {% for name, count in media_counts %}
  <li>{{ name }}: {{ count }}</li>
  {% endfor %}
</ul>
{% endblock %}
