{% extends "base.html" %}
{% block title %}Rank Media{% endblock %}
{% block content %}
{% if files %}
<div class="media-grid">
  {% for f in files %}
  <div class="media-container" data-file="{{ f }}" onclick="toggleRank(this)">
    <img class="media-preview" src="/media/{{ f }}" alt="{{ f }}" />
    <span class="medal"></span>
  </div>
  {% endfor %}
</div>
{% else %}
<p>No media files found</p>
{% endif %}
<script>
let selected = [];
const MAX_RANK = 4;
const REQUIRED_SELECTIONS = MAX_RANK - 1;

function updateLayout(){
  const header = document.querySelector('.header');
  const footer = document.querySelector('.footer');
  const root = document.documentElement;
  if(header) root.style.setProperty('--header-height', `${header.offsetHeight}px`);
  if(footer) root.style.setProperty('--footer-height', `${footer.offsetHeight}px`);
}

window.addEventListener('load', () => {
  updateLayout();
  document.querySelectorAll('.media-preview').forEach(img => {
    img.classList.add('fade-in');
  });

  const form = document.getElementById('rate-form');
  if(form){
    form.addEventListener('submit', e => {
      e.preventDefault();
      document.querySelectorAll('.media-preview').forEach(img => img.classList.add('fade-out'));
      setTimeout(() => form.submit(), 500);
    });
  }
});
window.addEventListener('resize', updateLayout);
function toggleRank(el){
  const file = el.dataset.file;
  const idx = selected.indexOf(file);
  if(idx >= 0){
    selected.splice(idx,1);
  } else if(selected.length < REQUIRED_SELECTIONS){
    selected.push(file);
  }
  update();
}
function update(){
  document.querySelectorAll('.media-container').forEach(c=>{
    const medal = c.querySelector('.medal');
    const idx = selected.indexOf(c.dataset.file);
    medal.textContent = '';
    medal.className = 'medal';
    if(idx === 0){ medal.textContent='ðŸ¥‡'; }
    else if(idx === 1){ medal.textContent='ðŸ¥ˆ'; }
    else if(idx === 2){ medal.textContent='ðŸ¥‰'; }
  });
  let order = [...selected];
  document.querySelectorAll('.media-container').forEach(c=>{
    if(!order.includes(c.dataset.file)) order.push(c.dataset.file);
  });
  document.getElementById('order').value = order.join(',');
  document.getElementById('submit-btn').disabled = selected.length < REQUIRED_SELECTIONS;
}

document.addEventListener('keydown', e => {
  if(e.key === 'Enter'){
    const btn = document.getElementById('submit-btn');
    if(btn && !btn.disabled){
      btn.click();
      return;
    }
  }
  const n = parseInt(e.key);
  if(n >= 1 && n <= MAX_RANK){
    const containers = document.querySelectorAll('.media-container');
    if(containers[n-1]) toggleRank(containers[n-1]);
  }
});

</script>
{% endblock %}

{% block footer %}
{% if files %}
<form id="rate-form" action="/rate" method="post">
  <input type="hidden" id="order" name="order" />
  <button id="submit-btn" type="submit" disabled>Submit</button>
</form>
{% endif %}
{% endblock %}
